var express = require('express');
var router = express.Router();

const { Sequelize, QueryTypes } = require('sequelize');
var path = require('path');

/* GET home page. */
router.get('/', async function(req, res, next) {
  const sequelize = new Sequelize(process.env.DATABASE_URL);

  try {
    await sequelize.authenticate();
    const posts = await sequelize.query('SELECT * FROM `posts`', {
      type: QueryTypes.SELECT,
    });

    res.render('posts', { title: 'Posts Sample', posts: posts });
  }   catch (error) {
    console.error('Unable to connect to the database:', error);
    res.render('post', { title: req.params.postId, message: 'Hello' });
  }
});

router.get('/img/:attachmentPath', function(req, res, next) {
  res.sendFile(path.resolve('attachment', req.params.attachmentPath), {
    dotfiles: 'allow',
  });
});

router.get('/:postId', async function(req, res, next) {
  const sequelize = new Sequelize(process.env.DATABASE_URL);

  try {
    const post = await sequelize.query('SELECT * FROM `posts` WHERE `slug` = ' + `'${req.params.postId}'`, {
      // replacements: [],
      raw: true,
      type: QueryTypes.SELECT,
    });

    console.debug(post)

    res.render('post', { title: post[0].title, post: post[0] });
  } catch (error) {
    res.send(error, 404);
  }
});

module.exports = router;
